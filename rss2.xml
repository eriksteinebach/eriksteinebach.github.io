<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>NET, DevOps, Architecture, Azure, Erik Steinebach</title>
    <link>http://eriksteinebach.com/</link>
    <atom:link href="/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description>I am a digital nomad, a .NET developer, a software architect, a development process consultant and a new technology enthusiast. Originally from The Netherlands, but currently living in Lima, Peru.</description>
    <pubDate>Mon, 11 Jun 2018 01:53:24 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>Javascript script for Application Insights</title>
      <link>http://eriksteinebach.com/2018/06/10/application-insights-for-javascript-script/</link>
      <guid>http://eriksteinebach.com/2018/06/10/application-insights-for-javascript-script/</guid>
      <pubDate>Mon, 11 Jun 2018 01:33:40 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;There are a lot of scripts available on how to implement Application Insights on the server side. Also, for a lot of different ways to cu
        
      
      </description>
      
      <content:encoded><![CDATA[<p>There are a lot of scripts available on how to implement Application Insights on the server side. Also, for a lot of different ways to customize the logging. But I had a hard time finding how to customize Application Insights on the client side (in javascript). So below I include the script we use with some customizations you can use to log what you want to get out of appInsights.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> appInsights = <span class="built_in">window</span>.appInsights || <span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">config</span>) </span>&#123; t[config] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">var</span> i = <span class="built_in">arguments</span>; t.queue.push(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; t[config].apply(t, i) &#125;) &#125; &#125;</span><br><span class="line">    <span class="keyword">var</span> t = &#123; config: config &#125;, u = <span class="built_in">document</span>, e = <span class="built_in">window</span>, o = <span class="string">'script'</span>, s = u.createElement(o), i, f; <span class="keyword">for</span> (s.src = config.url || <span class="string">'//az416426.vo.msecnd.net/scripts/a/ai.0.js'</span>, u.getElementsByTagName(o)[<span class="number">0</span>].parentNode.appendChild(s), t.cookie = u.cookie, t.queue = [], i = [<span class="string">'Event'</span>, <span class="string">'Exception'</span>, <span class="string">'Metric'</span>, <span class="string">'PageView'</span>, <span class="string">'Trace'</span>, <span class="string">'Ajax'</span>]; i.length;) r(<span class="string">'track'</span> + i.pop()); <span class="keyword">return</span> r(<span class="string">'setAuthenticatedUserContext'</span>), r(<span class="string">'clearAuthenticatedUserContext'</span>), config.disableExceptionTracking || (i = <span class="string">'onerror'</span>, r(<span class="string">'_'</span> + i), f = e[i], e[i] = <span class="function"><span class="keyword">function</span> (<span class="params">config, r, u, e, o</span>) </span>&#123; <span class="keyword">var</span> s = f &amp;&amp; f(config, r, u, e, o); <span class="keyword">return</span> s !== !<span class="number">0</span> &amp;&amp; t[<span class="string">'_'</span> + i](config, r, u, e, o), s &#125;), t</span><br><span class="line">&#125;(&#123;</span><br><span class="line">    instrumentationKey: <span class="string">'@Model.AppInsightsInstrumentationKey'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">window</span>.appInsights = appInsights;</span><br><span class="line">appInsights.queue.push(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    @<span class="keyword">if</span> (!<span class="built_in">String</span>.IsNullOrWhiteSpace(User.Identity.Name))</span><br><span class="line">    &#123;</span><br><span class="line">        &lt;text&gt;</span><br><span class="line">        <span class="keyword">var</span> appInsightsUserName = <span class="string">'@User.Identity.Name.Replace("\\", "\\\\")'</span>;</span><br><span class="line">        appInsights.setAuthenticatedUserContext(appInsightsUserName.replace(<span class="regexp">/[,;=| ]+/g</span>, <span class="string">"_"</span>));</span><br><span class="line">        &lt;<span class="regexp">/text&gt;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    appInsights.context.addTelemetryInitializer(function (envelope) &#123;</span></span><br><span class="line"><span class="regexp">        if (envelope.name === Microsoft.ApplicationInsights.Telemetry.RemoteDependencyData.envelopeType &amp;&amp; envelope.data.baseData.target.indexOf("...") &gt; -1) &#123;</span></span><br><span class="line"><span class="regexp">            return false;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        if (envelope.name === Microsoft.ApplicationInsights.Telemetry.Exception.envelopeType &amp;&amp; envelope.data.baseData.message.contains("...")) &#123;</span></span><br><span class="line"><span class="regexp">            return false;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">    appInsights.viewPath = '&lt;nameofview&gt;';</span></span><br><span class="line"><span class="regexp">    appInsights.browserWidth = window.innerWidth;</span></span><br><span class="line"><span class="regexp">    appInsights.browserHeight = window.innerHeight;</span></span><br><span class="line"><span class="regexp">    appInsights.context.application.ver = '@typeof(&lt;Assembly.ClassName&gt;).Assembly.GetName().Version.ToString()';</span></span><br><span class="line"><span class="regexp">    appInsights.context.application.build = '@typeof(&lt;Assembly.ClassName&gt;).Assembly.GetName().Version.ToString()';</span></span><br><span class="line"><span class="regexp">    appInsights.trackPageView(null, null, &#123; urlReferrer: document.referrer &#125;);</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure><br>The first bit is just the standard Application Insights javascript script. This you can find anywhere.</p><p>Then we add our startup function to appInsights.queue.push. This way the startup function is called when application insights is fully loaded. </p><p>Next, we set the user authentication context based on the current principal. You can find more on this in my blogpost <a href="/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId/">“Follow a specific user with Application Insights by setting AuthenticatedUserId”</a>.</p><p>Next, we can add TelemetryInitializers, but we mostly use them to filter certain items. We have a javascript framework included in our app that we use to show popups or function tours to our users. We make calls to this system every request and I don’t have any need seeing these calls in our logs, so we filter those out. We also filter some exceptions that are caused by browser extensions.</p><p>Finally, we set some values (which are pretty obvious I think) and we call trackPageView to log the page view with our values.</p><p>This gives us lots of good information on what our users are doing and see all errors users experience with our javascript code.</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2018/06/10/application-insights-for-javascript-script/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Generic client for sending events to Event Grid</title>
      <link>http://eriksteinebach.com/2018/05/14/generic-client-for-sending-events-to-eventgrid/</link>
      <guid>http://eriksteinebach.com/2018/05/14/generic-client-for-sending-events-to-eventgrid/</guid>
      <pubDate>Mon, 14 May 2018 13:05:45 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;To support the use of Event Grid in our application architecture we decided to build a generic Event Grid client to send our events. This
        
      
      </description>
      
      <content:encoded><![CDATA[<p>To support the use of Event Grid in our application architecture we decided to build a generic Event Grid client to send our events. This client enforces some practices like the use of base events and error logging.</p><h3 id="Event-Grid-event-schema"><a href="#Event-Grid-event-schema" class="headerlink" title="Event Grid event schema"></a>Event Grid event schema</h3><p>Event Grid events have a set schema which needs to be send and which Event Grid will again route to subscribers. The json looks like this (this is an event defined by Azure Storage):</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"topic"</span>: <span class="string">"/subscriptions/&#123;subscription-id&#125;/resourceGroups/Storage/providers/Microsoft.Storage/storageAccounts/xstoretestaccount"</span>,</span><br><span class="line">    <span class="attr">"subject"</span>: <span class="string">"/blobServices/default/containers/oc2d2817345i200097container/blobs/oc2d2817345i20002296blob"</span>,</span><br><span class="line">    <span class="attr">"eventType"</span>: <span class="string">"Microsoft.Storage.BlobCreated"</span>,</span><br><span class="line">    <span class="attr">"eventTime"</span>: <span class="string">"2017-06-26T18:41:00.9584103Z"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"831e1650-001e-001b-66ab-eeb76e069631"</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">      <span class="attr">"api"</span>: <span class="string">"PutBlockList"</span>,</span><br><span class="line">      <span class="attr">"clientRequestId"</span>: <span class="string">"6d79dbfb-0e37-4fc4-981f-442c9ca65760"</span>,</span><br><span class="line">      <span class="attr">"requestId"</span>: <span class="string">"831e1650-001e-001b-66ab-eeb76e000000"</span>,</span><br><span class="line">      <span class="attr">"eTag"</span>: <span class="string">"0x8D4BCC2E4835CD0"</span>,</span><br><span class="line">      <span class="attr">"contentType"</span>: <span class="string">"application/octet-stream"</span>,</span><br><span class="line">      <span class="attr">"contentLength"</span>: <span class="number">524288</span>,</span><br><span class="line">      <span class="attr">"blobType"</span>: <span class="string">"BlockBlob"</span>,</span><br><span class="line">      <span class="attr">"url"</span>: <span class="string">"https://oc2d2817345i60006.blob.core.windows.net/oc2d2817345i200097container/oc2d2817345i20002296blob"</span>,</span><br><span class="line">      <span class="attr">"sequencer"</span>: <span class="string">"00000000000004420000000000028963"</span>,</span><br><span class="line">      <span class="attr">"storageDiagnostics"</span>: &#123;</span><br><span class="line">        <span class="attr">"batchId"</span>: <span class="string">"b68529f3-68cd-4744-baa4-3c0498ec19f0"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"dataVersion"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"metadataVersion"</span>: <span class="string">"1"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Most fields are probably pretty logical, but I want to call out the data field, because this is where you can put your own “Event” data. To make it easy to work with I made a POCO class to represent the event schema. This way you can serialize back and forth easily between json and a class. The Data field is represented as a generic T, because this could be of any type. You could add a generic class or a JObject if you need a generic representation of the event (if you want to receive multiple different event types for example.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class GridEvent&lt;T&gt; where T : class</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Subject &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> EventType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> T Data &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime EventTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Topic &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> DataVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MetadataVersion &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>I made some base classes for specific events which would be in the Data block. For example every event in our organization contains a SourceApplicationName and we have the validationcode added in this event to support easier handling of returning the validationcode when a Event Grid event subscription is added. We have another base event that inherits from that one for user specific events with a UserId. All events need to inherit from these base events, something the generic client enforces.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AppGridEvent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SourceApplicationName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ValidationCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AppGridUserEvent</span> : <span class="title">AppGridEvent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Guid UserId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Generic-client"><a href="#Generic-client" class="headerlink" title="Generic client"></a>Generic client</h3><p>Sending events is easy. It is just a HTTP Post, but still there is value in having a generic client to do this. It can handle a couple of things for you that make life easier. </p><p><strong>Configuration</strong><br>Our clients constructor takes a couple of configuration values:<br><strong>TopicEndpointUrl</strong>: The url where events will be send<br><strong>SasToken</strong>: The token used to authenticate with EventGrid (so you are allowed to send the event)<br><strong>ApplicationName</strong>: Name of the calling application so we always know the source (this is automatically set by the client)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventClient</span> : <span class="title">IEventClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EventClientConfig _config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TelemetryClient _telemetryClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _client;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventClient</span>(<span class="params">EventClientConfig config, TelemetryClient telemetryClient</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"config"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.TopicEndpointUrl == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"TopicEndpointUrl cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.SasToken == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"SasToken cannot be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config.ApplicationName == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"ApplicationName cannot be null"</span>);</span><br><span class="line">    </span><br><span class="line">        _config = config;</span><br><span class="line">        _telemetryClient = telemetryClient;</span><br><span class="line">        </span><br><span class="line">        _client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">        client.DefaultRequestHeaders.Add(<span class="string">"aeg-sas-key"</span>, _config.SasToken);</span><br><span class="line">        client.DefaultRequestHeaders.UserAgent.ParseAdd(_config.ApplicationName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="keyword">bool</span>&gt; SendEventAsync&lt;T&gt;(T eventData) <span class="keyword">where</span> T : AppGridEvent</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>These settings come from an object out of our appsettings.json, but obviously could come from where ever you like. </p><p>In the constructor we also initialize the HttpClient. Note that every HttpClient constructor call registers a new port on your machine, so our EventClient needs to be used as a singleton or static in your application.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (eventData == <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"eventData"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gridEvent = <span class="keyword">new</span> GridEvent&lt;T&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    Id = Guid.NewGuid().ToString(),</span><br><span class="line">    EventType = <span class="keyword">typeof</span>(T).Name,</span><br><span class="line">    EventTime = DateTime.UtcNow,</span><br><span class="line">    Subject = eventData.Subject,</span><br><span class="line">    Data = eventData,</span><br><span class="line">    DataVersion = <span class="string">""</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">gridEvent.Data.SourceApplicationName = _config.ApplicationName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span> json = JsonConvert.SerializeObject(<span class="keyword">new</span> List&lt;GridEvent&lt;T&gt;&gt;() &#123; gridEvent &#125;);</span><br><span class="line">HttpRequestMessage request = <span class="keyword">new</span> HttpRequestMessage(HttpMethod.Post, _config.TopicEndpointUrl)</span><br><span class="line">&#123;</span><br><span class="line">    Content = <span class="keyword">new</span> StringContent(json, Encoding.UTF8, <span class="string">"application/json"</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = <span class="keyword">await</span> _client.SendAsync(request);</span><br></pre></td></tr></table></figure><p>The client receives a generic object of base type AppGridEvent which contains the base fields like ApplicationName. This base type is serialized in json and a HttpRequestMessage is created. This message is send to EventGrid and we record if a successful message is return. </p><p>One open point right now is versioning. When the time comes when we need it, I plan to get the version from an attribute on the POCO class.</p><h3 id="Catching-exceptions"><a href="#Catching-exceptions" class="headerlink" title="Catching exceptions"></a>Catching exceptions</h3><p>In our application events that we throw don’t need to be transaction. We want as many as possible, but if we sometimes miss some, that is fine. So we catch any errors that occur on sending of the event, because we don’t want this to bubble up to the user. This works very well for us, because we rather miss an event than the user being impacted by one of these errors. But keep in mind, this might not work for everyone/all type of events.<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    ...    </span><br><span class="line">    <span class="keyword">if</span> (!result.IsSuccessStatusCode)</span><br><span class="line">    &#123;</span><br><span class="line">        _telemetryClient.TrackException(<span class="keyword">new</span> Exception(<span class="string">$"SendEventAsync resulted in invalid statuscode <span class="subst">&#123;result.StatusCode.ToString()&#125;</span>"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result.IsSuccessStatusCode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception exc)</span><br><span class="line">&#123;</span><br><span class="line">    _telemetryClient.TrackException(exc);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>In case of an incorrect result status code we log this code, but you could also throw an exception here. Keep in mind that you will need to check this, just catching exceptions is not enough to see all failed requests.</p><h3 id="Sharing-of-events-event-types"><a href="#Sharing-of-events-event-types" class="headerlink" title="Sharing of events (event types)"></a>Sharing of events (event types)</h3><p>At the moment we use a nuget package to share events definitions (in the form of the POCO classes) between the different applications that use this event. This package is stored in a private Visual Studio online package repositry. This works very well and enforces that when the event is changed (and the nuget package is updated) the applications break. But it does somewhat break the principle that the source application is the owner of the schema.</p><p>Until now this approach has been working well for us. But I am always open for suggestions, so if you see possible improvements, please let me know!</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2018/05/14/generic-client-for-sending-events-to-eventgrid/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Azure Event Grid vs Azure Service Bus</title>
      <link>http://eriksteinebach.com/2018/05/10/azure-eventgrid-vs-azure-servicebus/</link>
      <guid>http://eriksteinebach.com/2018/05/10/azure-eventgrid-vs-azure-servicebus/</guid>
      <pubDate>Thu, 10 May 2018 22:56:16 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;When I started looking into solutions for routing events to our new microservice, it took me a while to get a clear picture of the differ
        
      
      </description>
      
      <content:encoded><![CDATA[<p>When I started looking into solutions for routing events to our new microservice, it took me a while to get a clear picture of the differences between Azure Event Grid and Azure Service Bus. In this blogpost I want to share my findings and try to show what the differences are. Hopefully this will help you find the best solution for your problem, because these are not a one or the other products. Both Event Grid and Service Bus have different characteristics, and both can be a valid solution for your problem.</p><h3 id="Azure-Event-Grid"><a href="#Azure-Event-Grid" class="headerlink" title="Azure Event Grid"></a>Azure Event Grid</h3><ul><li>Event Grid is more like a router for events<ul><li>Push based model, based on HTTP calls (both ingoing and outgoing)</li><li>Event Grid has an available endpoint where you can send events (http post). When receiving events, EventGrid will route them to subscribers, based on the configuration made in Event Grid (This can be done through the portal or with a management API) </li><li>With pay on use solutions (with for example Azure functions) you don’t pay anything when there is no traffic. Not for Event Grid or for your receiving and sending application, because there are no polling threads that need to be active)<br><br></li></ul></li><li>Retry mechanism <ul><li>Retries at 10, 30 seconds, 1, 5, 10, 30 minutes, 1 hour, every hour up till 24 hours, with small randomization of those times<br><br></li></ul></li><li>Filtering <ul><li>Can be done by EventType and Subject (custom string per event) </li><li>For Subject only filtering on StartsWith and EndsWith are available (nothing more complex)<br><br>    </li></ul></li><li>Not transactional (because of retries you have a reasonable guarantee of at least once delivery)<br><br></li><li>Doesn’t have a local emulator, so local testing is tricky <h3 id="Azure-Service-Bus"><a href="#Azure-Service-Bus" class="headerlink" title="Azure Service Bus"></a>Azure Service Bus</h3></li><li>Service Bus is a queue-based system<ul><li>Pull based, receiving needs to pull a queue (ingoing is writing to queue, outgoing is pull from queue)</li><li>The application writes an event to a queue, the receiving system monitors this queue. With Azure Functions/WebJob polling the queue is fully abstracted, but there will always be an active thread<br><br>  </li></ul></li><li>Retry mechanism <ul><li>Can be customized by reader, but both writing, and reading could be done 100% transactional</li><li>Azure functions/webjob triggers offer an out of the box solution for this<br><br></li></ul></li><li>Filering<ul><li>Much more customization possibilities compared to Event Grid. SQL style language to write filters for topics<br><br>  </li></ul></li><li>100% transactional (in and out)<br><br>  </li><li>Service Bus also doesn’t have a good local emulator, but I could imagine using an azure queue as an alternative should be possible. I didn’t test this or do much research on this though</li></ul><p>For my project Event Grid was the system we were looking for. We are building a notification system, where 100% accurate delivery is not required. The cost savings and ease of development were the deciding factors for us to go with Event Grid. We almost switched to Service Bus when we figured out that there was no local emulator, because this is quite limiting during development, but because Service Bus has the same problem, we went with Event Bus anyway. </p><p>I hope this comparison will help you pick the correct eventing solution for you.</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2018/05/10/azure-eventgrid-vs-azure-servicebus/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Follow a specific user in Application Insights .NET Core edition</title>
      <link>http://eriksteinebach.com/2018/05/06/specific-user-application-insights-netcore/</link>
      <guid>http://eriksteinebach.com/2018/05/06/specific-user-application-insights-netcore/</guid>
      <pubDate>Sun, 06 May 2018 17:20:03 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;In 2016 &lt;a href=&quot;/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId&quot;&gt;I wrote how to track a spec
        
      
      </description>
      
      <content:encoded><![CDATA[<p>In 2016 <a href="/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId">I wrote how to track a specific user in Application Insights</a> which has been very useful in tracking down production issues. Now we are starting to upgrade our project to .NET Core so I wanted to share how to do this in .NET Core. In .NET Core you can use the same method, the ITelemetryInitializer:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthenticatedUserInitializer</span> : <span class="title">ITelemetryInitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IHttpContextAccessor _httpContextAccessor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuthenticatedUserInitializer</span>(<span class="params">IHttpContextAccessor httpContextAccessor</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _httpContextAccessor = httpContextAccessor ?? <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"httpContextAccessor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">ITelemetry telemetry</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> httpContext = _httpContextAccessor.HttpContext;</span><br><span class="line">        <span class="keyword">if</span> (httpContext?.User?.Identity?.Name != <span class="literal">null</span> &amp;&amp; httpContext.User.Identity.IsAuthenticated == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            telemetry.Context.User.AuthenticatedUserId = httpContext.User.Identity.Name;</span><br><span class="line">            telemetry.Context.User.AccountId = httpContext.User.FindFirst(<span class="string">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"</span>)?.Value ?? telemetry.Context.User.AccountId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The interface is the same. To get access to the users information we need to access the user in the HttpContext. In .NET Core you get access to the HttpContext through the “IHttpContextAccessor” interface. Depending on the setup of your identity you can select the required information. We use our users email address (which is accessed through Identity.Name) as the AuthenticatedUserId. For the AccountId we use the unique user id (Guid in our case). In case no userId is available we use the accountId generated by Application Insights.</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2018/05/06/specific-user-application-insights-netcore/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Follow a specific user with Application Insights by setting AuthenticatedUserId</title>
      <link>http://eriksteinebach.com/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId/</link>
      <guid>http://eriksteinebach.com/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId/</guid>
      <pubDate>Mon, 26 Dec 2016 14:32:08 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;In my latest project we embraced Application Insights as our logging and tracking platform. I am impressed by its capabilities and ease o
        
      
      </description>
      
      <content:encoded><![CDATA[<p>In my latest project we embraced Application Insights as our logging and tracking platform. I am impressed by its capabilities and ease of use when hosting on Azure. It already has been very useful and it is free, because the amount of data we track is within 1 GB or 5M data points per month.</p><h3 id="User-tracking"><a href="#User-tracking" class="headerlink" title="User tracking"></a>User tracking</h3><p>The only thing I felt was missing was (specific) user tracking. Out of the box AppInsights stores a user key with every tracked item, but this is a random value. This is good, because it lets you track and group all the telemetry of one user, but we don’t know who that user is. We wanted to add a username or email to the telemetry so we could track a specific user.</p><h3 id="Why-we-wanted-to-track-a-specific-user"><a href="#Why-we-wanted-to-track-a-specific-user" class="headerlink" title="Why we wanted to track a specific user"></a>Why we wanted to track a specific user</h3><p>There is for me no doubt Application Insights is very useful, only last week I fixed 3 exceptions before the user’s could let us know things were broken, because they showed up in App Insights. Also this week I noticed a javascript error in a browser version we don’t test ourselves because of time constrains. An error we otherwise would have missed. So both clear wins!</p><p>A good example, why tracking the user is useful, was a user who said there was a bug in the system. We couldn’t reproduce the issue, but by looking at his session we figured out he was using the system differently then we anticipated. It did spark a discussion if the system was clear enough, but it turned out not to be a bug. A good thing to know and it was very useful and a time saver that we could track the user.</p><h3 id="Connecting-your-user-system-with-Application-Insights"><a href="#Connecting-your-user-system-with-Application-Insights" class="headerlink" title="Connecting your user system with Application Insights"></a>Connecting your user system with Application Insights</h3><p>Application Insights out of the box generates a random value because it doesn’t know about your users. You might be using Active directory, ASP.NET Identity, a custom solution or something else, so you have to link those up yourself. </p><p>App Insights can track server and client side. This means it tracks items on the server within ASP.NET and it tracks client side in the javascript running in the users browsers. The server side tracks for example Requests, Dependencies and Exceptions. On the client it tracks for example page views and user events like a button click. On all those request we wanted to add the username.</p><h3 id="How-to-track-the-user-server-side"><a href="#How-to-track-the-user-server-side" class="headerlink" title="How to track the user server side"></a>How to track the user server side</h3><p>Implement the ITelementryInitializer interface. The Initialize method is called on every telemetry item that is tracked. So it is important to keep the method very simple to not slow down your application. It will be called a lot. The easiest, and what we ended up doing, is set the CurrentPrincipal Identity Name as the AuthenticatedUserId. AuthenticatedUserId is a standard property available on every tracked item and in our system the Identity.Name is set to the users username (which is their email address). This is what the class looks like:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AppInsightsInitializer</span> : <span class="title">ITelemetryInitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params">ITelemetry telemetry</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.CurrentPrincipal != <span class="literal">null</span> &amp;&amp; </span><br><span class="line">            Thread.CurrentPrincipal.Identity != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            telemetry.Context.User.AuthenticatedUserId = </span><br><span class="line">                          Thread.CurrentPrincipal.Identity.Name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>When you created this Initializer you need to load it on application load. You can do this by adding this to you Startup.cs or Global.asax:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TelemetryConfiguration.Active.TelemetryInitializers</span><br><span class="line">                                  .Add(<span class="keyword">new</span> AppInsightsInitializer());</span><br></pre></td></tr></table></figure><h3 id="How-to-track-the-user-on-the-client"><a href="#How-to-track-the-user-on-the-client" class="headerlink" title="How to track the user on the client"></a>How to track the user on the client</h3><p>For client side Application Insights tracking we already added some javascript to every page. We set the user by calling the setAuthenticatedUserContext on the appInsights object. This method sets the same AuthenticatedUserId. Here we also take the Identity Name as the value:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> appInsightsUserName = <span class="string">'@User.Identity.Name.Replace("\\", "\\\\")'</span>;</span><br><span class="line">appInsights.setAuthenticatedUserContext(</span><br><span class="line">                        appInsightsUserName.replace(<span class="regexp">/[,;=| ]+/g</span>, <span class="string">"_"</span>));</span><br><span class="line">appInsights.trackPageView();</span><br></pre></td></tr></table></figure>Now all your Application Insights telemetry contains the username of the user (when that user is logged in at least). Happy user tracking!</p><p>More information can be found here:<br><a href="https://docs.microsoft.com/en-us/azure/application-insights/app-insights-api-custom-events-metrics" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/application-insights/app-insights-api-custom-events-metrics</a></p><p>Edit: <a href="/2018/05/06/specific-user-application-insights-netcore/">Updated version for .NET Core</a></p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2016/12/26/Follow-a-specific-user-with-Application-Insights-by-setting-AuthenticatedUserId/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Issues continuous deploying a ASP.NET core 1.0 / AngularJS 2.0 app into Azure</title>
      <link>http://eriksteinebach.com/2016/07/29/issues-continuous-deploying-a-aspnetcore-1-angularjs-2-app-into-azure/</link>
      <guid>http://eriksteinebach.com/2016/07/29/issues-continuous-deploying-a-aspnetcore-1-angularjs-2-app-into-azure/</guid>
      <pubDate>Fri, 29 Jul 2016 21:25:00 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;For a personal project (and to work with some new technology) I build a new ASPNET Core 1.0 website using AngularJS2. To make further dev
        
      
      </description>
      
      <content:encoded><![CDATA[<p>For a personal project (and to work with some new technology) I build a new ASPNET Core 1.0 website using AngularJS2. To make further development easier for myself, I wanted to enable continuous deployment, so my web application would be deployed into Azure on every checkin. Because the used technology is all relatively new, I didn’t expect it to work the first try and it took me some time to get it to work correctly. I included my errors and solutions for anyone who is doing the same and runs in the same issues. I expect most will come here by googling one of the errors ;).</p><p><img src="Visual-Studio-Team-Services.png" alt=""><br><strong>My approach</strong><br>I used <a href="http://yeoman.io/" target="_blank" rel="noopener">Yeoman’s</a> template generator-aspnetcore-spa to generate the basis of this project, you can find the how to <a href="http://blog.stevensanderson.com/2016/05/02/angular2-react-knockout-apps-on-aspnet-core/" target="_blank" rel="noopener">here</a>.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yo generator-aspnetcore-spa</span><br></pre></td></tr></table></figure><br>Then I used <a href="https://www.visualstudio.com/en-us/docs/build/apps/aspnet/aspnetcore-to-azure" target="_blank" rel="noopener">this</a> tutorial to deploy this aspnetcore app to azure. A quick note here, I used VSTS deployment, so the deployment is configured in VSTS, so I am not using Kudu (this makes a difference, more on this later). I hoped the deployment would be smooth, but not quite. I will discribe the issues and explain how I solved them.</p><p><strong>Issue number 1: Web Deploy cannot modify the file ‘Client.dll’ (Using the “Deploy Website to Azure” task)</strong><br><em>[error]Microsoft.Web.Deployment.DeploymentDetailedClientServerException: Web Deploy cannot modify the file ‘Client.dll’ on the destination because it is locked by an external process. In order to allow the publish operation to succeed, you may need to either restart your application to release the lock, or use the AppOffline rule handler for .Net applications on your next publish attempt. Learn more at: <a href="http://go.microsoft.com/fwlink/?LinkId=221672#ERROR_FILE_IN_USE" target="_blank" rel="noopener">http://go.microsoft.com/fwlink/?LinkId=221672#ERROR_FILE_IN_USE</a>.</em></p><p>This error is caused by the application still being active when you are deploying. The task doesn’t stop the application, which you also not always want to happen. The “old” “Deploy Website to Azure” release task works, but doesn’t include the option to take the app offline before deploying. Initially I switched to the “Deploy AzureRM Web App” release task, because this task does support that option. But because of another issue (see the next error) I decided the switch back and I solved this problem by shutting the app down, before the deploy and starting it back up after. This is no problem for my app, but this might not be ideal for every website. You can add powershell steps, so you can do whatever works in your scenario.</p><p><strong>Issue number 2: Error: Source does not support parameter called ‘IIS Web Application Name’ with a green Build (Using the “Deploy AzureRM Web App” task)</strong><br>The “Deploy AzureRM Web App” runs msdeploy under the hood to deploy to azure. I ran into 2 issues here: I got the error: <em>“Error: Source does not support parameter called ‘IIS Web Application Name’. Must be one of ().”</em> and given that error, the build was green. </p><p>The green build is a known issue, see <a href="https://github.com/Microsoft/vsts-tasks/issues/2118" target="_blank" rel="noopener">here</a>. So this should be solved soon. The other issue was trickier, I found two solutions:</p><ul><li><a href="http://www.factus.dk/post/2016/07/04/Build-and-deployment-of-ASPNET-Core-10-to-Azure-App-Service" target="_blank" rel="noopener">http://www.factus.dk/post/2016/07/04/Build-and-deployment-of-ASPNET-Core-10-to-Azure-App-Service</a></li><li><a href="https://github.com/Microsoft/vsts-rm-extensions/issues/51#event-698986554" target="_blank" rel="noopener">https://github.com/Microsoft/vsts-rm-extensions/issues/51#event-698986554</a></li></ul><p>Based on this information I added a parameters.xml and set.parameters.xml file to my project and configured the build to use these files. This solved this problem, but then gave me the following error:</p><p><strong>Issue number 3: Error Code: ERROR_INSUFFICIENT_ACCESS_TO_SITE_FOLDER</strong><br><em>More Information: Unable to perform the operation (“Create Directory”) for the specified directory (“C:\a\1\s...\src\Client\bin...\”). This can occur if the server administrator has not authorized this operation for the user credentials you are using. Learn more at: <a href="http://go.microsoft.com/fwlink/?LinkId=221672#ERROR_INSUFFICIENT_ACCESS_TO_SITE_FOLDER" target="_blank" rel="noopener">http://go.microsoft.com/fwlink/?LinkId=221672#ERROR_INSUFFICIENT_ACCESS_TO_SITE_FOLDER</a>.<br>Error: The error code was 0x80070005.<br>Error: Access to the path ‘C:\a’ is denied.</em></p><p><del>It looks like the contentPath was not being set correctly in the msdeploy package, so I tried setting it myself through the parameter file and through commandline arguments, but in both situations without result. Because I was not sure what was happening I decided to switch back to the “Deploy Website to Azure” task, because that one worked fine. I just had to add the powershell scripts to stop and start the website.</del></p><p>Edit: After I finished writing this blogpost I got a possible solution to this problem on <a href="https://github.com/Microsoft/vsts-tasks/issues/2122" target="_blank" rel="noopener">Github</a>. After the weekend I will try this out and see if this solves my error.</p><p><strong>Issue number 4: Exception: Call to Node module failed with error: To use prerendering, you must install the ‘aspnet-prerendering’ NPM package.</strong><br>So now my application was being deployed through continuous delivery, but my website was not working yet. Locally my application ran fine, but on Azure I got the following exception:<br><em>Exception: Call to Node module failed with error: To use prerendering, you must install the ‘aspnet-prerendering’ NPM package.</em> I temporarily changed:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app</span>    <span class="attr">asp-prerender-module</span>=<span class="string">"ClientApp/boot-server"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">asp-prerender-webpack-config</span>=<span class="string">"webpack.config.js"</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br></pre></td></tr></table></figure>into:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">app</span>&gt;</span><span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br></pre></td></tr></table></figure>That did the trick, but this would lose me the prerendering which is actually pretty cool and useful. So what is going wrong here?</p><p>It sounds like this is a problem not related to deployment, but it turns out it actually is. The cause of this error is that the folder <em>“node_modules”</em> is not being deployed, and aspnetcore needs those for the server side node execution. This is because in the generator-aspnetcore-spa template a .gitignore file is added that blocks (ignores) the <em>“node_modules”</em> folder from being checked in. The idea behind this (I assume) is that during deployment the correct modules are downloaded and added to the website so it all works again. This has some advantages and disadvantages. I am not sure what the best way to go is, so I think I will write a blogpost about this to order my own thoughts on this. If you have ideas about this let me know in the comments. </p><p>And this also brought up another point which I didn’t realize: There is a difference between deploying from VSTS into Azure and attaching your source repository in VSTS (or other git host) to your Azure website. Deployment from VSTS is with MSBuild, deployment from Azure goes via Kudu. And deploying the same solution over MSBuild or via Kudu gives a different result. This is something to be aware of. I think I will write another blogpost with my feelings about Kudu. For the details about this issue see <a href="https://github.com/aspnet/JavaScriptServices/issues/222" target="_blank" rel="noopener">my github question</a>.</p><style type="text/css">.article-entry li{ margin-left: 2.2em; list-style-position: outside; }</style>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2016/07/29/issues-continuous-deploying-a-aspnetcore-1-angularjs-2-app-into-azure/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Creating charts with d3.js and ASP.NET MVC</title>
      <link>http://eriksteinebach.com/2016/05/25/Creating-charts-with-d3js-and-ASPNET-MVC/</link>
      <guid>http://eriksteinebach.com/2016/05/25/Creating-charts-with-d3js-and-ASPNET-MVC/</guid>
      <pubDate>Wed, 25 May 2016 13:24:47 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;For a recent project I needed to create a line chart and a bar chart. Previously I used the ASP.NET chart controls, but in the new ASP.NE
        
      
      </description>
      
      <content:encoded><![CDATA[<p>For a recent project I needed to create a line chart and a bar chart. Previously I used the ASP.NET chart controls, but in the new ASP.NET Core the chart control is not available anymore, so I went looking for something new. Because of the many single page applications build in javascript these days I figured a javascript based solution would be the best investment for the future. With client computers and browsers being fast enough, there really is no need anymore to generate charts on the server.  After some research I choose <a href="https://d3js.org/" target="_blank" rel="noopener">D3.js</a>.</p><blockquote><p>“D3.js is a javascript library for producing dynamic, interactive data visualizations in web browsers. It makes use of the widely implemented SVG, HTML5, and CSS standards. It is the successor to the earlier Protovis framework.” - Wikipedia</p></blockquote><p>D3.js is a highly flexible and powerful library to build a variety of different data visualizations. But the downside of being so powerful is that it is not so easy to understand at first. That is why I wanted to make this blog post. I am going to assume you are a developer like me, so you have knowledge of HTML, CSS, Javascript and for the .NET parts also knowledge of ASP.NET. I will walk you through creating a bar chart and a line chart. And will explain how to get the data for your chart from the server. After that you should have a basic understanding of D3.js, to also be able to build other visualizations. See other visualizations <a href="https://github.com/d3/d3/wiki/Gallery" target="_blank" rel="noopener">here</a>. </p><h3 id="How-to-make-a-bar-chart"><a href="#How-to-make-a-bar-chart" class="headerlink" title="How to make a bar chart"></a>How to make a bar chart</h3><p>To build a chart we start with a basic page, with the d3.js reference and a <a href="http://www.w3schools.com/html/html5_svg.asp" target="_blank" rel="noopener">SVG</a> (Scalable Vector Graphics) element. This SVG is used to draw the chart. With javascript we give the SVG a width and height and we store those in a variable, because we will need those later. We also have a set of data that we can use to draw. Later we will take the data from a JSON call.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://d3js.org/d3.v3.min.js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">&lt;svg id=<span class="string">"barChart"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> data = [ <span class="number">50</span>,<span class="number">90</span>,<span class="number">30</span>,<span class="number">10</span>,<span class="number">70</span>,<span class="number">20</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> w = <span class="number">500</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> h = <span class="number">100</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> svg = d3.select(<span class="string">"#barChart"</span>)</span></span><br><span class="line"><span class="javascript">            .attr(<span class="string">"width"</span>, w)</span></span><br><span class="line"><span class="javascript">            .attr(<span class="string">"height"</span>, h);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>That is the basic setup, we continue with drawing the bars:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">svg.selectAll(<span class="string">"rect"</span>)</span><br><span class="line">    .data(data)</span><br><span class="line">    .enter()</span><br></pre></td></tr></table></figure>This takes the data and for every item in the array (basic number or complex type) makes a rectangle. After the enter() function every other chained function is called for every rectangle. Because every rectangle needs an x and y (start position coordinate) and a width and height we will add those like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.attr(<span class="string">"x"</span>, <span class="number">0</span>)</span><br><span class="line">.attr(<span class="string">"y"</span>, <span class="number">0</span>)</span><br><span class="line">.attr(<span class="string">"width"</span>, <span class="number">20</span>)</span><br><span class="line">.attr(<span class="string">"height"</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>But this only gives us what looks like 1 rectangle (it are actually 6 rectangles on top of each other), because the values obviously are bar specific. First we change the x for every rectangle:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d, i</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i * <span class="number">21</span>;  <span class="comment">//Bar width of 20 plus 1 for padding</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>This moves every bar next to the previous bar (the bars are 20 pixels wide, plus 1 pixel padding inbetween). Then we change the height so it has the height of the value:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> .attr(<span class="string">"height"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> d;  <span class="comment">//Just the data value</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>But now the bar is upside down, so we correct the y to start so all the bars line out on the bottom:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.attr(<span class="string">"y"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> h - d;  <span class="comment">//Height minus data value</span></span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>Here is what we have so far, you can play with the javascript to see what happens with the bars:<a class="jsbin-embed" href="http://jsbin.com/wubufu/5/embed?html,output" target="_blank" rel="noopener">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.35.12"></script><br>I added some color to the chart with the fill attribute, just to make it a little nicer. You can use javascript or CSS to style your chart (later you will see a css example).</p><p>The example is nice, but this only works because the data matches the pixels of the chart. What if they don’t, because that is like.. always? Well then you use <a href="https://github.com/d3/d3/wiki/Quantitative-Scales" target="_blank" rel="noopener">scales</a>, a functions to map from an input domain to an output range. To be able to show a full bar chart we make the data a bit more complex:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [ &#123;  Product: <span class="string">"Shoes"</span>, Count: <span class="number">5</span>   &#125;,</span><br><span class="line">      &#123;  Product: <span class="string">"Shirts"</span>,  Count: <span class="number">9</span>  &#125;,</span><br><span class="line">      &#123;  Product: <span class="string">"Pants"</span>,  Count: <span class="number">3</span>   &#125;,</span><br><span class="line">      &#123;  Product: <span class="string">"Ties"</span>,  Count: <span class="number">1</span>  &#125;,</span><br><span class="line">      &#123; Product: <span class="string">"Socks"</span>,  Count: <span class="number">7</span>  &#125;,</span><br><span class="line">      &#123;  Product: <span class="string">"Jackets"</span>,  Count: <span class="number">2</span>  &#125;];</span><br></pre></td></tr></table></figure>Probably a more realistic dataset.</p><p>So we make scales, an ordinal scale (<a href="https://github.com/d3/d3/wiki/Ordinal-Scales#ordinal_rangeBands" target="_blank" rel="noopener">more info here</a>) for the bars, and a linear scale for the height of the bars:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//An ordinal scale, to support the bars, we choose </span></span><br><span class="line"><span class="keyword">var</span> x = d3.scale.ordinal()</span><br><span class="line">    .rangeRoundBands([width, <span class="number">0</span>], <span class="number">0.1</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//I think this makes a lot of sense (just a default scale converter)</span></span><br><span class="line"><span class="keyword">var</span> y = d3.scale.linear()</span><br><span class="line">    .range([<span class="number">0</span>, height]); </span><br></pre></td></tr></table></figure>And we add the “mapping”, the domain:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The x domain is a map of all the Products names</span></span><br><span class="line">x.domain(data.map(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;  <span class="keyword">return</span> d.Product; &#125;));</span><br><span class="line"><span class="comment">//The y domain is a range from the maximal (Count) value in the array until 0</span></span><br><span class="line">y.domain([d3.max(data, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d.Count;  &#125;), <span class="number">0</span>]);</span><br></pre></td></tr></table></figure>Then we can use that information to set the right x,y,width,height info for the bars. You use x() and y() functions for that. The rangeBand function is to help set the width for the bars:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//the x function, transforms the value, based on the scale</span></span><br><span class="line">    <span class="keyword">return</span> x(d.Product); </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//The rangeBand() function returns the width of the bars</span></span><br><span class="line">.attr(<span class="string">"width"</span>, x.rangeBand()) </span><br><span class="line">.attr(<span class="string">"y"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> y(d.Count); <span class="comment">//the y function does the same</span></span><br><span class="line">&#125;)</span><br><span class="line">.attr(<span class="string">"height"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> height - y(d.Count);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>Now you have a fully working bar chart (with correct scaling):<br><a class="jsbin-embed" href="http://jsbin.com/kixaqa/8/embed?html,output" target="_blank" rel="noopener">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.35.12"></script><br>This is a nice start, but I think most people would like to add some axis (see the inline comments for more info):<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xAxis = d3.svg.axis() <span class="comment">//Create an axis</span></span><br><span class="line">    .scale(x) <span class="comment">//scale the axis</span></span><br><span class="line">    .orient(<span class="string">"bottom"</span>); <span class="comment">//this is where the labels will be located</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> yAxis = d3.svg.axis()</span><br><span class="line">    .scale(y)</span><br><span class="line">    .orient(<span class="string">"left"</span>)</span><br><span class="line">    .tickFormat(d3.format(<span class="string">"d"</span>)) <span class="comment">//Ticks are the divisions on the scale. </span></span><br><span class="line">    .tickSubdivide(<span class="number">0</span>); <span class="comment">//Here we want to see only whole numbers on the axis</span></span><br><span class="line"></span><br><span class="line">svg.append(<span class="string">"g"</span>)</span><br><span class="line">    .attr(<span class="string">"class"</span>, <span class="string">"y axis"</span>)</span><br><span class="line">    .call(yAxis);</span><br><span class="line"></span><br><span class="line">svg.append(<span class="string">"g"</span>)</span><br><span class="line">    .attr(<span class="string">"class"</span>, <span class="string">"y axis"</span>)</span><br><span class="line">    .attr(<span class="string">"transform"</span>, <span class="string">"translate(0,"</span> + height + <span class="string">")"</span>)</span><br><span class="line">    .call(xAxis)</span><br><span class="line">    .selectAll(<span class="string">"text"</span>) <span class="comment">//In some cases the labels will overlap</span></span><br><span class="line">    .attr(<span class="string">"transform"</span>, <span class="string">"rotate(90)"</span>) <span class="comment">//so you might for example want to rotate the label's so they are vertical</span></span><br><span class="line">    .attr(<span class="string">"x"</span>, <span class="number">0</span>) <span class="comment">//After that you might have to do some finetuning to align everything the right way:</span></span><br><span class="line">    .attr(<span class="string">"y"</span>, <span class="number">-6</span>)</span><br><span class="line">    .attr(<span class="string">"dx"</span>, <span class="string">".6em"</span>)</span><br><span class="line">    .style(<span class="string">"text-anchor"</span>, <span class="string">"start"</span>);</span><br></pre></td></tr></table></figure>And now we have a full chart (I also added some CSS styling):<br><a class="jsbin-embed" href="http://jsbin.com/kixaqa/6/embed?html,output" target="_blank" rel="noopener">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.35.12"></script><br>Or as an extra example, the same data in a bar chart with <a href="http://jsbin.com/parase/1/edit?html,output" target="_blank" rel="noopener">horizontal bars</a>. I wanted to share this example as well, because it turned out to be a bit more complex then I expected. Comparing them is a good way to see if you understand D3.js</p><h3 id="How-to-make-a-line-chart"><a href="#How-to-make-a-line-chart" class="headerlink" title="How to make a line chart"></a>How to make a line chart</h3><p>Another very common chart is the line chart. I build on top of what we learned with the bar chart, so I assume you understand the scaling:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"lineChart"</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    .line &#123;</span></span><br><span class="line"><span class="undefined">      fill: none;</span></span><br><span class="line"><span class="undefined">      stroke: steelblue;</span></span><br><span class="line"><span class="undefined">      stroke-width: 2px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> data = [<span class="number">50</span>,<span class="number">90</span>,<span class="number">30</span>,<span class="number">10</span>,<span class="number">70</span>,<span class="number">20</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> width = <span class="number">500</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> height = <span class="number">100</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> svg = d3.select(<span class="string">"#lineChart"</span>)</span></span><br><span class="line"><span class="javascript">              .attr(<span class="string">"width"</span>, width)</span></span><br><span class="line"><span class="javascript">              .attr(<span class="string">"height"</span>, height);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> x = d3.scale.linear()</span></span><br><span class="line"><span class="undefined">  .range([0, width]);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> y = d3.scale.linear()</span></span><br><span class="line"><span class="undefined">  .range([height, 0]);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  x.domain([0, data.length]);</span></span><br><span class="line"><span class="javascript">  y.domain([<span class="number">0</span>, d3.max(data, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d; &#125;)]);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> line = d3.svg.line()</span></span><br><span class="line"><span class="javascript">            .x(<span class="function"><span class="keyword">function</span> (<span class="params">d, i</span>) </span>&#123; <span class="keyword">return</span> x(i); &#125;)</span></span><br><span class="line"><span class="javascript">            .y(<span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> y(d); &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        svg.append(<span class="string">"path"</span>)</span></span><br><span class="line"><span class="undefined">            .datum(data)</span></span><br><span class="line"><span class="javascript">            .attr(<span class="string">"class"</span>, <span class="string">"line"</span>)</span></span><br><span class="line"><span class="javascript">            .attr(<span class="string">"d"</span>, line);</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>This results in this line chart:<br><a class="jsbin-embed" href="http://jsbin.com/zezumeg/8/embed?html,output" target="_blank" rel="noopener">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.35.12"></script><br>Very basic, but a line chart. Some things of note for the chart example:</p><ul><li>The scales are both linear</li><li>The domains are set to size of the array and to the max value in the array</li><li>The line is drawn by plotting the index of the array against the value in the array</li><li>Then we add the line to the svg, as a path</li><li>If you do not add any style for the line, it will look a bit strange, because it will fill the object by default (just try it out to see, remove the style block in the JSBin example), so normally you will add a style.</li><li>Of course you can also add axis to this if you want, in the same way as with the bar chart.</li></ul><p>Now the only thing left is styling your charts to make them look great! </p><h3 id="Get-data-via-an-JSON-call-ASP-NET-MVC"><a href="#Get-data-via-an-JSON-call-ASP-NET-MVC" class="headerlink" title="Get data via an JSON call (ASP.NET MVC)"></a>Get data via an JSON call (ASP.NET MVC)</h3><p>Mmost of the time the information for the chart comes from a database on the server. Although you could generate the javascript to create the data array, a cleaner solution is to make an JSON call to fetch the data. D3.js includes a perfect function to do this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">d3.json(<span class="string">"MyController/MyAction"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//Here you have data available, an object with the same structure </span></span><br><span class="line">    <span class="comment">//as the JSON that was send by the server.</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>In ASP.NET Core 1.0 the function that will be called should look like this:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">MyAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Json( <span class="keyword">new</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Shoes"</span> , Count = <span class="number">5</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Shirts"</span> , Count = <span class="number">9</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Pants"</span> , Count = <span class="number">3</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Ties"</span> , Count = <span class="number">1</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Socks"</span> , Count = <span class="number">7</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> &#123; Product = <span class="string">"Jackets"</span> , Count = <span class="number">2</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>And with that you have a complete chart with data from the server. If you need an “almost no development skills”, or a more indepth tutorial for D3.js you can also look <a href="http://alignedleft.com/tutorials/d3" target="_blank" rel="noopener">here</a>. Let me know if you have any questions. Happy charting! </p><style type="text/css">.article-entry li{ margin-left: 2.2em; list-style-position: outside; }</style>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2016/05/25/Creating-charts-with-d3js-and-ASPNET-MVC/#disqus_thread</comments>
    </item>
    
    <item>
      <title>How to deal with time (in .NET and on Azure)</title>
      <link>http://eriksteinebach.com/2016/05/17/how-to-deal-with-time/</link>
      <guid>http://eriksteinebach.com/2016/05/17/how-to-deal-with-time/</guid>
      <pubDate>Tue, 17 May 2016 21:28:43 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;Handling time in .NET applications, it seems straight forward (“just use the .NET &lt;code&gt;DateTime&lt;/code&gt; object”) and in some scenario’s i
        
      
      </description>
      
      <content:encoded><![CDATA[<p>Handling time in .NET applications, it seems straight forward (“just use the .NET <code>DateTime</code> object”) and in some scenario’s it also is, but not for everything. In your local hobby project you will be fine, but I am sure everyone venturing further than that, will have experienced that working with time in .NET is not always so easy and/or logical.  </p><p>I will cover 3 different scenarios that I have encountered and how we solved those. This is by no means a complete list, but I do think they cover the main scenarios:</p><ol><li>A locally developed website used by people in the same country and hosted in that country</li><li>A relatively small application, used by people in the same country, but hosted on Azure</li><li>An application with user from all over the world</li></ol><p><img src="clock-407101_1280.jpg" alt=""></p><h3 id="1-A-locally-developed-website-used-by-people-in-the-same-country-and-hosted-in-that-country"><a href="#1-A-locally-developed-website-used-by-people-in-the-same-country-and-hosted-in-that-country" class="headerlink" title="1. A locally developed website used by people in the same country and hosted in that country"></a>1. A locally developed website used by people in the same country and hosted in that country</h3><p>This scenario is why I think not everyone runs into trouble with <code>DateTime</code> when they first start out developing .NET applications. If we make the assumption that the development machine, the user machines and the server (host) machine are all configured with the same time zone, the .NET DateTime object works fine.</p><p>You don’t really need time conversion in your application, which makes the application definitely less complex. Yay for you! There are some things to consider though:</p><ul><li>Does your time zone have summer and winter time? If so what happens in that hour that overlaps each year? Will this cause a problem in your application? It might for example mix up events occurring in the hour before the switch and the hour after. Is this a problem? If not, don’t worry to much about it, I am a big proponent of lean development. Leave it be for now. But a possible solution in this situation would be to store time in UTC time. This makes it a little bit more complex, but will solve those problems. You can use the build-in ToUniversalTime and ToLocalTime on the DateTime object to do this.</li><li>What happens when one of your users wants to use the application when he goes to another time zone? This is not a problem if you can tell your user he has to input the time based on your applications time zone, but of course that is not very user friendly, so it is something to consider. To solve this your application will have to implement scenario 3. Your product owner will have to decide if that investment is worth the money.</li></ul><h3 id="2-A-relatively-small-app-used-by-people-in-the-same-country-but-hosted-on-Azure"><a href="#2-A-relatively-small-app-used-by-people-in-the-same-country-but-hosted-on-Azure" class="headerlink" title="2. A relatively small app, used by people in the same country, but hosted on Azure"></a>2. A relatively small app, used by people in the same country, but hosted on Azure</h3><p>So this scenario is why I ran into trouble with <code>DateTime</code>. My application is for users in Peru, so I only wanted to convert to the Peruvian time zone from UTC and the other way around. Scenario 3 was overkill in this situation, so I was looking for a simpler solution. To make it confusing, my development machine was set in local Peruvian time and the server the application was hosted on was in UTC (Azure). So the application responded differently on my development machine compared to Azure. Of course differences between development and productions are unwanted, but I think in this case for most people unavoidable. Who sets his development machine in UTC time (let me know!)? Some people maybe, but everyone who also does normal work on there computer can’t. Another case for automated testing!</p><p><strong>So how can you handle these situations?</strong><br>If you try to solve this problem with the standard <code>DateTime</code> object you run into a problem. For example, the user needs to select a date or time, so you make a select field (with a nice datetimepicker) and store the datetime in a DateTime object in your MVC model. On the server you immediately convert the datetime to UTC. Sounds easy, but wait…</p><p>My first instinct was to do something this (like scenario 1):<br><figure class="highlight csharp"><figcaption><span>Basic (but wrong) conversion</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This is the same thing that happens when the MVC model is filled</span></span><br><span class="line"><span class="keyword">var</span> date = DateTime.Parse( <span class="string">"2016-5-16 18:59:00"</span>); </span><br><span class="line"><span class="keyword">var</span> utc = date.ToUniversalTime();</span><br></pre></td></tr></table></figure><br>And this works on my development machine, but fails on Azure. <code>DateTime</code> interprets the datetime based on the computer time zone, because the Kind property is set to Unspecified (during model binding). So on my development PC it uses a 5 hour UTC offset (based on my computers time zone), but on Azure the UTC offset is 0 (because Azure servers run on UTC time). So where my local machines stored the right UTC time in the database, on Azure the time the user inputted was directly stored as UTC in the database.</p><p>To solve this you have to use a specific time zone to convert the value:<br><figure class="highlight csharp"><figcaption><span>Convert time with timezone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This is the same thing that happens when the MVC model is filled</span></span><br><span class="line"><span class="keyword">var</span> date = DateTime.Parse( <span class="string">"2016-5-16 18:59:00"</span>); </span><br><span class="line">TimeZoneInfo tzi = TimeZoneInfo.FindSystemTimeZoneById(<span class="string">"SA Pacific Standard Time"</span>);</span><br><span class="line"><span class="keyword">var</span> utc = TimeZoneInfo.ConvertTimeToUtc(date , tzi);</span><br></pre></td></tr></table></figure></p><p>This means you need to know the time zone of the user. If you have an application where only one time zone is required this can be a config setting.</p><h3 id="3-An-application-with-users-from-all-over-the-world"><a href="#3-An-application-with-users-from-all-over-the-world" class="headerlink" title="3. An application with users from all over the world"></a>3. An application with users from all over the world</h3><p>Let’s say you are building twitter. Every user of twitter wants to see time in his time zone, and even if he goes overseas he should see the correct time. There are 2 ways to approach this problem: </p><ol><li>Always use the time from the browser the user is currently browsing from (via javascript) to show the correct time.</li><li>Save the user time zone in a user profile</li></ol><p>In both cases you want to store time in UTC so wherever the user is from, events are always ordered in the right way. The first approach works very well when you have a javascript client, like an AngularJS website, because browser time will always be available. All your server code will use UTC time and on the client you can convert to the browser time zone. This has an advantage that it also corrects the time when a user is traveling (assuming he/she changes the computer/cellphone time of course). </p><p>When doing anything with time, you make your own life so much easier when using momentJS (<a href="http://momentjs.com/" target="_blank" rel="noopener">http://momentjs.com/</a>). With momentJs you can do the conversion like this:<br><figure class="highlight javascript"><figcaption><span>Conversion with momentJS</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> timeZoneName = <span class="string">"America/Lima"</span>;</span><br><span class="line"><span class="keyword">var</span> originalUtcDate = moment.utc();</span><br><span class="line"><span class="keyword">var</span> convertedDate = originalUtcDate.tz(timeZoneName);</span><br><span class="line"><span class="keyword">var</span> utcDate = convertedDate.utc();</span><br></pre></td></tr></table></figure><br>When you use ASP.NET MVC for example (or another traditional website) it is harder to get access to the browser time. So here it is easier to store the time zone of the user in his/her profile so you can access it on the server. In this case the user will have to change the time zone on the website when he/she travels. </p><p>When you know the timezone the user is in, you can convert the time from and to UTC in C# like this:<br><figure class="highlight csharp"><figcaption><span>Convert time with timezone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TimeZoneInfo tzi = TimeZoneInfo.FindSystemTimeZoneById(<span class="string">"SA Pacific Standard Time"</span>);</span><br><span class="line"><span class="keyword">var</span> originalUtcDate = DateTime.UtcNow;</span><br><span class="line"><span class="keyword">var</span> convertedDate = TimeZoneInfo.ConvertTimeFromUtc(originalUtcDate, tzi);</span><br><span class="line"><span class="keyword">var</span> utcDate = TimeZoneInfo.ConvertTimeToUtc(convertedDate, tzi);</span><br></pre></td></tr></table></figure><br>Another option, which I haven’t tried myself, but the idea sounds very interesting. You can still only use UTC time in MVC, and use javascript to convert times in the browser to the correct local time. This means identifying all datetime fields on page load and replace the values with corrected values and hook into form post events to change the values on post as well. It would be possible to write generic functions to do this, which would make life a lot easier and less prone for mistakes. </p><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>TLTR, some best practices for working with <code>DateTime</code> in .NET:</p><ul><li>Always store datetime information in the database in UTC</li><li>Know which time zone the user is working in. Make it explicit in some way (read the articles for options).</li><li>When working with javascript apps (for example AnjularJS), use the browser time and work on the server and on the wire always in UTC. This is a great clear boundary.</li><li>In MVC websites, this is harder, but I would advise converting to UTC as fast as you can. A good option is using client side javascript for this (because it makes it possible to use the browser time to convert to UTC) otherwise as soon as you are on the server (for example only use user time in the Model).</li><li>Understand that time conversion is super tricky, definitely when dealing with different time zones. Use official tested frameworks to do this. You can use momentJS (<a href="http://momentjs.com/" target="_blank" rel="noopener">http://momentjs.com/</a>) for javascript and/or Noda Time (<a href="http://nodatime.org/" target="_blank" rel="noopener">http://nodatime.org/</a>) in C# if you do any kind of complex datetime conversion math.</li><li>If you are interested in more best practices, see <a href="https://msdn.microsoft.com/en-us/library/ms973825.aspx" target="_blank" rel="noopener">this</a> comprehensive guide.</li></ul><p>This is not a complete guide, but a view in the complexities of time zone programming. If you have anything to add, do not agree or have other scenario’s to add, please leave a comment.</p><style type="text/css">.article-entry li{ margin-left: 2.2em; list-style-position: outside; }</style>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2016/05/17/how-to-deal-with-time/#disqus_thread</comments>
    </item>
    
    <item>
      <title>Blog reboot and changes</title>
      <link>http://eriksteinebach.com/2016/05/14/blog-reboot-and-changes/</link>
      <guid>http://eriksteinebach.com/2016/05/14/blog-reboot-and-changes/</guid>
      <pubDate>Sun, 15 May 2016 00:36:00 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;A new blogpost! Maybe you do not remember, but you subscribed to my blog. Don’t worry, it is totally possible you do not remember, becaus
        
      
      </description>
      
      <content:encoded><![CDATA[<p>A new blogpost! Maybe you do not remember, but you subscribed to my blog. Don’t worry, it is totally possible you do not remember, because my last post was almost 2 years ago. I was hoping to be able to blog while I was traveling, but it turned out I was to busy with discovering the world (for more info see <a href="http://eriksteinebach.nl" target="_blank" rel="noopener">http://eriksteinebach.nl</a> to do so. Now that I settled back down in Lima (Peru) for the time being, I want to reboot this blog. This means there will be new blogpost, a new design and that means a new blog system.</p><p><img src="change-1245949_640.jpg" alt=""></p><p>The new content will be a bit more broad then before. Until now I focused on DevOps, but I am originally a .NET developer and I am going back to my roots (or I will preferably do both). So expect more technical content as well on this blog. One of the first things I will post soon is about handling Time when deploying to Azure. It will always be bigger picture stuff.</p><p>For those who are following me via RSS, the URL will change. The new RSS url will be <a href="http://eriksteinebach.com/rss2.xml">http://eriksteinebach.com/rss2.xml</a>, but because this one is not yet available you can subscribe now to: <a href="http://eriksteinebach.github.io/rss2.xml" target="_blank" rel="noopener">http://eriksteinebach.github.io/rss2.xml</a>. This one will be active even after I change <a href="http://eriksteinebach.com">eriksteinebach.com</a> to the new blog. So if you want a preview of the new blog, you can look at <a href="http://eriksteinebach.github.io/" target="_blank" rel="noopener">http://eriksteinebach.github.io/</a>, but it is still in development.</p><p>As I am working as a freelancer, and bills have to be paid so I am always looking for new clients. If you are interested in working with me, please contact me to discus it further.</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2016/05/14/blog-reboot-and-changes/#disqus_thread</comments>
    </item>
    
    <item>
      <title>The difference between implementing DevOps in small and big teams</title>
      <link>http://eriksteinebach.com/2014/11/23/the-difference-between-implementing-devops-in-small-and-big-teams/</link>
      <guid>http://eriksteinebach.com/2014/11/23/the-difference-between-implementing-devops-in-small-and-big-teams/</guid>
      <pubDate>Sun, 23 Nov 2014 18:50:30 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;Jeff Knupp wrote about &lt;a href=&quot;http://jeffknupp.com/blog/2014/04/15/how-devops-is-killing-the-developer/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;
        
      
      </description>
      
      <content:encoded><![CDATA[<p>Jeff Knupp wrote about <a href="http://jeffknupp.com/blog/2014/04/15/how-devops-is-killing-the-developer/" target="_blank" rel="noopener">“How DevOps is killing the developer“</a>. I wanted to respond to this blog post, because you hear this view more often. But I think it stems from a misunderstanding about how DevOps is implemented in different size teams. Thats why I wanted to write about how DevOps should be implemented differently in small and big teams. But lets say first and foremost, DevOps will never kill the developer. How much Dev and Ops responsibilities are performed by the same person depends on the size and maturity of the company, but developers will always exist.</p><p>The goal of a company should be to get software into production in an efficient manner. This is where DevOps can help. The way to do this is by optimizing the development and operations processes by seeing them as one process instead of two different processes. Achieving this goal can be done in different ways and in my opinion this results in different solutions for different size teams.</p><p><img src="community-150124_640.png" alt=""></p><p><b>Small teams</b><br>The DevOps terms stems from startups. DevOps practices are relatively easily incorporated in startups because of their flexible nature, their relatively small teams and the DevOps practices probably aren’t far from the way they were already working. In smaller teams Dev and Ops responsibilities are already assigned to the same person which gives him/her the opportunity to optimize the full process.</p><p>Most of the time smaller teams (or single programmers) were already doing DevOps without knowing the term. Introducing DevOps might improve on that process and gives them a job title which more resembles their day-to-day work. In companies like this there might not be a “developer” as such anymore. But this will hopefully change when the company grows, and teams get bigger.</p><p><b>Bigger teams</b><br>When DevOps is practiced in bigger teams, DevOps works differently. Instead of sharing different parts of the job, DevOps is much more about communicating what you are doing and understanding what the other guy/girl is doing. And if you know what everybody is doing, it becomes possible to optimize the full process (the end goal).</p><p>When I look at developers and operators skills, I think of a T shape. The horizontal line stands for their broad knowledge on multiple subjects. The vertical line stands for specialization in their main specialism. For everyone the T will have a different shape. The horizontal and vertical lines will be different lengths for different people. Some people will specialize is a subject, but might not have a very broad view about other subjects (specialists). Some people have a broad view (know a little about everything), but it you go a little deeper into a subject, they are lost (the high level view). If someone focuses more on the vertical or horizontal line depends on your character. A healthy team should have a mix of different people.</p><p>Implementing DevOps means expending the horizontal line of the T shape for some people. It means that developers need to know more about operations. And that operators need to know more about development. But it doesn’t mean that the developer will do the operators work or the other way around. The members of the team will still have their own specialism (the vertical line) and work inside that specialism. We just try to give them a broader view. For some people this goes against character (they like to focus on their main skill) and this can cause friction and resistance.</p><p>How do we give people this broader view? Most effective is improving communication between people. An effective way is combining the operations team and the development team. The close proximity results in closer/better communication (if we do it right, but lets assume we did) and it gives the team the freedom to make the necessary changes, because all the stakeholders are represented in the team. The team becomes responsible for the full process and can optimize it. Note that I didn’t say here that one person is responsible. The team with stakeholders from the different disciplines must agree on the optimized process, but all the specialists will focus on implementing their part of the puzzle.</p><p>Although the way of implementing DevOps might be different, the result should be the same. The result should be an more efficient way of releasing software. This doesn’t mean that the developer “will be killed”, but DevOps makes sure they do a better job, be more efficient and have a clearer understanding of their environment. DevOps makes a developer more professional.</p>]]></content:encoded>
      
      <comments>http://eriksteinebach.com/2014/11/23/the-difference-between-implementing-devops-in-small-and-big-teams/#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
